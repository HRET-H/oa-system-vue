<!-- ‰ΩøÁî®vueÁöÑsetupËØ≠Ê≥ïÁ≥ñ -->
<script setup>
import { baseURL } from '@/utils/request'
// ÂØºÂÖ•axios
import axios from 'axios'
// ÂºïÂÖ•Ë∑ØÁî±
import { useRouter } from 'vue-router'
// ÂØºÂÖ•ÂºπÁ™ójs
import { openFullScreen, closeFullScreen } from '@/utils/loading'
// ÂØºÂÖ•Âä®ÊÄÅËèúÂçïÁªÑ‰ª∂
import MenuTree from '@/components/menu/MenuTree.vue'
// ÂºïÂÖ•piniaÁöÑuseUserStoreÊñπÊ≥ï
import { useUserStore } from '@/stores'

// Ëé∑ÂèñrouterÂÆû‰æã
const router = useRouter()

// ËÆæÁΩÆaxiosÁöÑbaseURL
axios.defaults.baseURL = baseURL

// Ëé∑ÂèñuseUserStoreÂÆû‰æã
const userStore = useUserStore()

// ÂÆö‰πâ‰∏Ä‰∏™refÂèòÈáèÔºåÁî®Êù•Â≠òÂÇ®ËèúÂçïÊï∞ÊçÆ
const MenuData = ref([])

// ÂàõÂª∫ÂÆ°ÊâπÁõÆÂΩï
const examine = ref({})
// ËèúÂçïÂêàÈõÜ
const examines = ref([])

// ÂÆö‰πâ‰∏Ä‰∏™refÂèòÈáèÔºåÊéßÂà∂Ê∞¥Âç∞ÁöÑÂÜÖÂÆπ
const watermark_content = ref('')

// Ëé∑ÂèñÂÆ°ÊâπÁõÆÂΩï
const getExamine = () => {
  // Ëé∑ÂèñÂÆ°ÊâπÊï∞ÊçÆ
  axios.get('/menu/selectMenuTree?parentId=' + 77).then((res) => {
    examine.value = res.data[0]
  })
}

// ‰ΩøÁî®onMountedÈí©Â≠êÂáΩÊï∞ÔºåËé∑ÂèñËèúÂçïÊï∞ÊçÆ
onMounted(() => {
  // Âà§Êñ≠objÊòØÂê¶‰∏∫Á©∫ÂØπË±°
  const isEmptyObject =
    Object.keys(userStore.user).length === 0 &&
    userStore.user.constructor === Object

  if (isEmptyObject) {
    ElMessage.error({
      message: 'ÊÇ®ËøòÊ≤°ÁôªÂΩïÔºåÂÖàÂéªÁôªÂΩï‰∏Ä‰∏ãÂè≠üéà',
      grouping: true,
      type: 'error'
    })
    router.push('/')
  } else {
    // Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥ Ê†ºÂºè‰∏∫ yyyy-MM-dd
    const now = new Date()
    const year = now.getFullYear()
    const month = now.getMonth() + 1
    const day = now.getDate()

    // ËÆæÁΩÆÊ∞¥Âç∞ÂÜÖÂÆπ
    watermark_content.value =
      userStore.user.userName + ' ' + year + '-' + month + '-' + day

    // ÂºÄÂêØÂä†ËΩΩÂä®Áîª
    const loading = openFullScreen()

    axios
      .get('/menu/selectMenuTree?parentId=' + 0)
      .then((res) => {
        MenuData.value = res.data

        getExamine()

        closeFullScreen(loading)
      })
      .catch(() => {
        ElMessage.error('ÁΩëÁªú‰∏ç‰Ω≥ËØ∑Á®çÂêéÈáçËØï!!!')
      })
  }
})

// Ëé∑ÂèñËèúÂçïÂêàÈõÜÁÇπÂáªÊåâÈíÆÁöÑrefÂºïÁî®
const clickOutSideRef = ref()
// Ëé∑ÂèñPopoverÂºπÂá∫Ê°ÜÁöÑrefÂºïÁî®
const popoverRef = ref()

// ÊòæÁ§∫ËèúÂçïÂêàÈõÜÊñπÊ≥ï
const onClickOutside = () => {
  // Âà§Êñ≠ËèúÂçïÈõÜÂêàÊòØÂê¶ÊúâÊï∞ÊçÆ
  if (examines.value.length === 0) {
    // Â∞ÜËèúÂçïÊï∞ÊçÆÊ∑ªÂä†Âà∞ËèúÂçïÈõÜÂêà‰∏≠  Âà©Áî®...Â±ïÂºÄËøêÁÆóÁ¨¶
    examines.value.push(...MenuData.value)
  }
  // ÊòæÁ§∫ËèúÂçïÂêàÈõÜ
  unref(popoverRef).popperRef?.delayHide?.()
}

// ÈÄÄÂá∫ÁôªÂΩï
const logout = () => {
  // Ê∂àÊÅØÂºπÂá∫Ê°ÜËØ¢ÈóÆ
  ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÔºü', 'Êìç‰ΩúÁ°ÆËÆ§', {
    confirmButtonText: 'Á°ÆËÆ§',
    cancelButtonText: 'ÂèñÊ∂à',
    type: 'warning'
  })
    .then(() => {
      ElMessage({
        type: 'success',
        message: 'ÊúüÂæÖ‰∏éÊÇ®‰∏ãÊ¨°Áõ∏ÈÅáüòâ'
      })

      // Âà†Èô§pinia‰∏≠ÁöÑuserÂÄº
      userStore.user = {}
      // Ë∑≥ËΩ¨Ëá≥ÁôªÂΩïÈ°µ
      router.push('/')
    })
    .catch(() => {
      ElMessage({
        type: 'info',
        message: 'Ê¨¢ËøéÂõûÊù•ü´®'
      })
    })
}
</script>

<template>
  <el-watermark :content="watermark_content">
    <!-- Â§ñÂ±ÇÂÆπÂô®„ÄÇ ÂΩìÂ≠êÂÖÉÁ¥†‰∏≠ÂåÖÂê´ <el-header> Êàñ <el-footer> Êó∂ÔºåÂÖ®ÈÉ®Â≠êÂÖÉÁ¥†‰ºöÂûÇÁõ¥‰∏ä‰∏ãÊéíÂàóÔºå Âê¶Âàô‰ºöÊ∞¥Âπ≥Â∑¶Âè≥ÊéíÂàó -->
    <el-container
      v-loading.fullscreen.lock="fullscreenLoading"
      element-loading-svg-view-box="-10, -10, 50, 50"
    >
      <!-- È°∂Ê†èÂÆπÂô® -->
      <el-header style="background-color: rgb(35, 43, 64); height: 68px">
        <el-row>
          <el-col :span="20">
            <el-row>
              <el-col :span="6">
                <span style="margin-left: 30px">
                  <el-image
                    style="
                      width: 30px;
                      height: 40px;
                      position: relative;
                      top: 15px;
                    "
                    src="https://hret0721.oss-cn-beijing.aliyuncs.com/oa-system/oa-Logo.png"
                    fit="fill"
                  />
                  &nbsp;
                  <h4 style="color: #fff; display: inline-block">
                    OAÊï∞Â≠óÂåñÂäûÂÖ¨Á≥ªÁªü
                  </h4>
                </span>
              </el-col>
              <el-col :span="16">
                <MenuTree
                  :data="MenuData"
                  mode="horizontal"
                  style="width: 50%; position: relative; top: 5px"
                />
              </el-col>
              <el-col
                :span="2"
                style="position: relative; left: -33%; top: 20px"
              >
                <a href="javascript:void(0)">
                  <v-icon
                    color="#fff"
                    icon="mdi-dots-grid"
                    ref="clickOutSideRef"
                    @click="onClickOutside"
                  />
                </a>
                <el-popover
                  ref="popoverRef"
                  :virtual-ref="clickOutSideRef"
                  trigger="click"
                  virtual-triggering
                  :width="examines.length * 82"
                >
                  <template v-for="(item, index) in examines" :key="index">
                    <div v-if="index === 1">
                      <div>{{ examine.menuName }}</div>
                      <el-row>
                        <el-col
                          v-for="(item, index) in examine.children"
                          :key="index"
                          span=""
                          style="margin: 10px 24px"
                        >
                          <router-link
                            style="text-decoration: none; color: #303133"
                            :to="item.menuPath + '?parentId=' + item.menuId"
                          >
                            <div>
                              <v-icon
                                :icon="item.menuIcon.split('|')[0]"
                                :color="item.menuIcon.split('|')[1]"
                                size="x-large"
                                v-if="
                                  item.menuIcon != null &&
                                  item.menuIcon !== '' &&
                                  item.menuIcon !== '#'
                                "
                              />
                              <v-icon icon="mdi-atom" color="#F56C6C" v-else />
                            </div>
                            <div>{{ item.menuName }}</div>
                          </router-link>
                        </el-col>
                      </el-row>
                    </div>
                    <div v-if="item.children[0].menuType === 'C'">
                      <div>{{ item.menuName }}</div>
                      <el-row>
                        <el-col
                          v-for="children in item.children"
                          :key="children"
                          span=""
                          style="margin: 10px"
                        >
                          <router-link
                            style="text-decoration: none; color: #303133"
                            :to="
                              children.menuPath + '?parentId=' + children.menuId
                            "
                          >
                            <div>
                              <v-icon
                                :icon="children.menuIcon.split('|')[0]"
                                :color="children.menuIcon.split('|')[1]"
                                size="x-large"
                                v-if="
                                  children.menuIcon != null &&
                                  children.menuIcon !== '' &&
                                  children.menuIcon !== '#'
                                "
                                :class="
                                  children.menuName.length === 3
                                    ? 'el-popover_three_icon'
                                    : 'el-popover_four_icon'
                                "
                              />
                              <v-icon icon="mdi-atom" color="#F56C6C" v-else />
                            </div>
                            <div>{{ children.menuName }}</div>
                          </router-link>
                        </el-col>
                      </el-row>
                    </div>
                  </template>
                </el-popover>
              </el-col>
            </el-row>
          </el-col>
          <el-col :span="4">
            <div style="float: right; margin-right: 10%">
              <a
                href="javascript:void(0)"
                style="position: relative; top: 25px"
                @click="router.push('/home/system?parentId=72')"
              >
                <el-icon color="#fff" size="20">
                  <Setting />
                </el-icon>
              </a>
              &nbsp;
              <el-dropdown style="position: relative; left: 10px; top: 5px">
                <el-avatar
                  :size="35"
                  :src="userStore.user.profilePhoto"
                  style="position: relative; top: 12px"
                  v-if="
                    userStore.user.profilePhoto != null &&
                    userStore.user.profilePhoto !== ''
                  "
                />
                <el-avatar
                  :size="35"
                  src="https://hret0721.oss-cn-beijing.aliyuncs.com/oa-system/userAll.png"
                  style="position: relative; top: 12px"
                  v-else
                />
                &nbsp;
                <span style="color: #fff">{{ userStore.user.userName }}</span>
                <el-icon style="color: #fff; margin-left: 5px">
                  <arrow-down />
                </el-icon>

                <template #dropdown>
                  <el-dropdown-menu>
                    <el-dropdown-item>
                      <v-icon icon="mdi-account-box-edit-outline" />
                      ËµÑÊñôËÆæÁΩÆ
                    </el-dropdown-item>
                    <el-dropdown-item>
                      <v-icon icon="mdi-key-variant" />
                      ‰øÆÊîπÂØÜÁ†Å
                    </el-dropdown-item>
                    <el-dropdown-item @click="logout">
                      <v-icon icon="mdi-application-export" />
                      ÈÄÄÂá∫ÁôªÂΩï
                    </el-dropdown-item>
                  </el-dropdown-menu>
                </template>
              </el-dropdown>
            </div>
          </el-col>
        </el-row>
      </el-header>
      <router-view></router-view>
    </el-container>
  </el-watermark>
</template>

<style>
*::-webkit-scrollbar {
  display: none;
}

/* ËèúÂçïÈõÜÂêàÂêçÂ≠ó‰∏∫3‰ΩçÊó∂ÁöÑÂõæÊ†áÊ†∑Âºè */
.el-popover_three_icon {
  position: relative;
  left: 8px;
}
/* ËèúÂçïÂêàÈõÜÂêçÂ≠ó‰∏∫4‰ΩçÊó∂ÁöÑÂõæÊ†áÊ†∑Âºè */
.el-popover_four_icon {
  position: relative;
  left: 15px;
}
</style>
